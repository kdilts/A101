<head>
	<script language=javascript>
var canvas; var gfx;

var cwidth; var cheight;

var planetSelector; var semimajorbox; var eccbox; var playpausebutton;
var slowmobox; var showsectorsbox; var slider; var showvelbox;
var minbox; var maxbox; var curbox; var distbox;

var interval; var playing = true; var currentPlanet = 'mercury';

var orbitEcc = .17; var orbitSemiMajor = 175; var slow = false;

var timer1 = 0.5; var timer2 = 0.5; var timerMax = 0.5;

var planetData = {
	mercury:{ semimajor: .387, ecc: .206, min:38.9, max:59.1 },
	venus:{ semimajor: .723, ecc: .007, min:34.8, max:35.3 },
	earth:{ semimajor: 1.0, ecc: .017, min:29.3, max:30.3 },
	mars:{ semimajor: 1.52, ecc: .093, min:22.0, max:26.5 },
	jupiter:{ semimajor: 5.2, ecc: .048, min:12.5, max:13.7 },
	saturn:{ semimajor: 9.55, ecc: .056, min:9.12, max:10.2 },
	uranus:{ semimajor: 19.2, ecc: .046, min:6.5, max:7.12 },
	neptune:{ semimajor: 30.1, ecc: .009, min:5.39, max:5.48 },
	pluto:{ semimajor: 39.7, ecc: .252, min:3.66, max:6.12 },
	halley:{ semimajor: 17.9, ecc: .967, min:0.913, max:54.4 }
}

window.onload = function(){
	canvas = document.createElement('canvas');
	document.body.appendChild(canvas);
	cwidth = canvas.width = window.innerWidth*.6;
	cheight = canvas.height = window.innerHeight;
	canvas.setAttribute('style','position:absolute; left:0; top:0');

	gfx = canvas.getContext('2d');
	orbiter.init();
	
	planetSelector =  document.getElementById('planetSelect');
	semimajorbox = document.getElementById('semimajor');
	eccbox = document.getElementById('eccentricity');
	playpausebutton = document.getElementById('playpause');
	slowmobox = document.getElementById('slowmo');
	showsectorsbox = document.getElementById('showsectors');
	slider = document.getElementById('slider');
	showvelbox = document.getElementById('showvel');

	minbox = document.getElementById('minvel');
	maxbox = document.getElementById('maxvel');
	curbox = document.getElementById('curvel');
	distbox = document.getElementById('distbox');

	semimajorbox.value = ''+planetData.mercury.semimajor + ' AU';
	eccbox.value = ''+planetData.mercury.ecc;
	semimajorbox.disabled = true; eccbox.disabled = true;
	minbox.value = ''+planetData.mercury.min + ' km/s';
	maxbox.value = ''+planetData.mercury.max + ' km/s';

	semimajorbox.onchange = function(){
		if(isNaN(parseFloat(semimajorbox.value))){ semimajorbox.value = ''; return; }
		updateOrbit();
	}
	eccbox.onchange = function(){
		if(isNaN(parseFloat(eccbox.value))){ eccbox.value = ''; return; }
		updateOrbit();
	}

	playpausebutton.onclick = function(){
		if(playing){
			clearInterval(interval);
			playing = false;
		}else{
			interval = setInterval(render,1000/60);
			playing = true;
		}
	}

	slider.onchange = function(){
		timerMax = lerp(0,100,slider.value,0,.5);
		timer1 = timer2 = timerMax;
	}

	slowmobox.onchange = function(){
		if(slowmobox.checked){
			slow = true;
		}else{
			slow = false;
		}
	}

	planetSelector.onchange = function(){
		switch(parseInt(planetSelector.value)){
			case 0:
				currentPlanet = 'mercury';
				semimajorbox.disabled = true; eccbox.disabled = true;
				break;
			case 1:
				currentPlanet = 'venus';
				semimajorbox.disabled = true; eccbox.disabled = true;
				break;
			case 2:
				currentPlanet = 'earth';
				semimajorbox.disabled = true; eccbox.disabled = true;
				break;
			case 3:
				currentPlanet = 'mars';
				semimajorbox.disabled = true; eccbox.disabled = true;
				break;
			case 4:
				currentPlanet = 'jupiter';
				semimajorbox.disabled = true; eccbox.disabled = true;
				break;
			case 5:
				currentPlanet = 'saturn';
				semimajorbox.disabled = true; eccbox.disabled = true;
				break;
			case 6:
				currentPlanet = 'uranus';

				semimajorbox.disabled = true; eccbox.disabled = true;
				break;
			case 7:
				currentPlanet = 'neptune';
				semimajorbox.disabled = true; eccbox.disabled = true;
				break;
			case 8:
				currentPlanet = 'pluto';
				semimajorbox.disabled = true; eccbox.disabled = true;
				break;
			case 9:
				currentPlanet = 'halley';
				semimajorbox.disabled = true; eccbox.disabled = true;
				break;
			case 10:
				currentPlanet = 'custom';
				semimajorbox.value = '';
				eccbox.value = '';
				minbox.value = ''; // TODO
				maxbox.value = ''; // TODO
				semimajorbox.disabled = false; eccbox.disabled = false;
				return;
			break;
		}
				semimajorbox.value = ''+planetData[currentPlanet].semimajor + ' AU';
				eccbox.value = ''+planetData[currentPlanet].ecc;
				minbox.value = ''+planetData[currentPlanet].min + ' km/s';
				maxbox.value = ''+planetData[currentPlanet].max + ' km/s';
				//orbitSemiMajor = planetData[currentPlanet].semimajor;
				orbitEcc = planetData[currentPlanet].ecc;
	}

	interval = setInterval(render,1000/60);
}

window.onresize = function(){
	cwidth = canvas.width = window.innerWidth*.6;
	cheight = canvas.height = window.innerHeight;
}

window.onmousemove = function(){}

window.onmousedown = function(){}

render = function(){
	gfx.fillStyle='black';
	gfx.fillRect(0,0,cwidth,cheight);

	drawSectors();

	gfx.fillStyle = gfx.strokeStyle = 'white';
	ellipse2(cwidth/2-200,250,cwidth/2+200,250,orbitEcc,orbitSemiMajor);

	gfx.fillStyle = gfx.strokeStyle = 'yellow';
	gfx.beginPath();
	gfx.arc(cwidth/2+100,250,20,0,Math.PI*2);
	gfx.fill();
	gfx.stroke();

	gfx.fillStyle = gfx.strokeStyle = 'green';
	gfx.lineWidth = 3;
	gfx.beginPath();
	gfx.moveTo(cwidth/2-175,60);
	gfx.lineTo(cwidth/2-175,40);
	gfx.moveTo(cwidth/2,60);
	gfx.lineTo(cwidth/2,40);
	gfx.moveTo(cwidth/2-175,50);
	gfx.lineTo(cwidth/2,50);
	gfx.fill();
	gfx.stroke();
	gfx.lineWidth = 1;
	gfx.font = '17px verdana';
	if(currentPlanet !== 'custom'){
		gfx.fillText(planetData[currentPlanet].semimajor + ' AU',cwidth/2-125,45);
	}else{
		if(semimajorbox.value.indexOf('U') !== -1 && !isNaN(parseFloat(semimajorbox.value))){
			gfx.fillText(semimajorbox.value,cwidth/2-125,45);
		}
	}
	
	orbiter.draw();

}

orbiter = {
	pos:null,
	offset:null,
	rot:Math.PI,
	mem:[],
	idx:0,
	vel:null,
	draw:function(){
		gfx.fillStyle = gfx.strokeStyle = 'red';
		gfx.beginPath();
		gfx.arc(orbiter.pos.x,orbiter.pos.y,10,0,Math.PI*2);
		gfx.fill();
		gfx.stroke();

		if(showvelbox.checked){
			orbiter.mem[orbiter.idx] = orbiter.pos;
			orbiter.idx++;
			if(orbiter.idx > 5){ orbiter.idx = 0; }
			
			var i = orbiter.idx-3;
			if(i < 0){ i += 5; }
			if(orbiter.mem[i]){
				orbiter.vel = sub(orbiter.pos,add(orbiter.offset,orbiter.mem[i]));
				orbiter.vel = mult(unit(orbiter.vel),55+30);
			}

			if(orbiter.vel){
				gfx.save();
				gfx.strokeStyle='blue';
				gfx.lineWidth=4;
				gfx.beginPath();
				gfx.moveTo(orbiter.pos.x,orbiter.pos.y);
				gfx.lineTo(orbiter.pos.x+orbiter.vel.x,orbiter.pos.y+orbiter.vel.y);
				gfx.stroke();
				orbiter.vel = null;
				gfx.restore();
			}
		}

		orbiter.update();
	},
	update:function(){
		// calculate distance
		var d = mag(sub(orbiter.pos,new vec2(cwidth/2+100,250)));
		
		// update position
		orbiter.offset.x = cwidth/2;

		orbiter.pos.x = 1.0*orbitSemiMajor*Math.cos(orbiter.rot);
		orbiter.pos.y = (1-orbitEcc)*orbitSemiMajor*Math.sin(orbiter.rot)*(-1);
		orbiter.pos = add(orbiter.pos,orbiter.offset);

		if(slow){
			orbiter.rot += (lerp(75,275,d,.025,.008)/3);
		}else{
			orbiter.rot += lerp(75,275,d,.025,.008);
		}

		if(orbiter.rot > Math.PI*2){ orbiter.rot = orbiter.rot % Math.PI*2 }

		var scale = parseFloat(semimajorbox.value)/200;

		distbox.value = (''+(d*scale)).substr(0,8) + ' AU';
		curvel.value = (''+lerp(75,275,d,.025,.008)).substr(0,8) + ' km/s'; // TODO
	},
	init:function(){
		orbiter.pos = new vec2(325,250);
		orbiter.offset = new vec2(500,250);
	}
}

drawSectors = function(){
		var angle = lerp(0,100,slider.value,.0001,Math.PI/2);

		/*console.clear();
		if(orbiter.rot > Math.PI*2-angle || orbiter.rot < angle){
			console.log('cyan');
		}

		if(orbiter.rot > -angle+Math.PI && orbiter.rot < angle+Math.PI){
			console.log('magenta');
		}*/

		if(showsectorsbox.checked){
		gfx.save();
		gfx.translate(cwidth/2,250);
		gfx.lineWidth = 2;
		gfx.fillStyle = 'cyan'
		gfx.strokeStyle = 'white';

		gfx.beginPath();
		for(var i = 0; i < angle; i += .01){
			var x = 1.0*orbitSemiMajor*Math.cos(i);
			var y = (1-orbitEcc)*orbitSemiMajor*Math.sin(i)*(-1);
			if(i === 0){ gfx.moveTo(x,y); }else{ gfx.lineTo(x,y); }
		}
		gfx.lineTo(100,0);
		gfx.fill();
		gfx.stroke();

		gfx.beginPath();
		for(var i = 0; i > -angle; i -= .01){
			var x = 1.0*orbitSemiMajor*Math.cos(i);
			var y = (1-orbitEcc)*orbitSemiMajor*Math.sin(i)*(-1);
			if(i === 0){ gfx.moveTo(x,y); }else{ gfx.lineTo(x,y); }
		}
		gfx.lineTo(100,0);
		gfx.fill();
		gfx.stroke();

		gfx.fillStyle = 'magenta'
		gfx.beginPath();
		for(var i = 0; i < angle; i += .01){
			var x = 1.0*orbitSemiMajor*Math.cos(i+Math.PI);
			var y = (1-orbitEcc)*orbitSemiMajor*Math.sin(i+Math.PI)*(-1);
			if(i === 0){ gfx.moveTo(x,y); }else{ gfx.lineTo(x,y); }
		}
		gfx.lineTo(100,0);
		gfx.fill();
		gfx.stroke();

		gfx.beginPath();
		for(var i = 0; i > -angle; i -= .01){
			var x = 1.0*orbitSemiMajor*Math.cos(i+Math.PI);
			var y = (1-orbitEcc)*orbitSemiMajor*Math.sin(i+Math.PI)*(-1);
			if(i === 0){ gfx.moveTo(x,y); }else{ gfx.lineTo(x,y); }
		}
		gfx.lineTo(100,0);
		gfx.fill();
		gfx.stroke();

		gfx.restore();
	}

	gfx.strokeStyle = gfx.fillStyle = 'magenta';
	gfx.fillRect(cwidth/2-300,450,200,100);

	gfx.strokeStyle = gfx.fillStyle = 'cyan';
	gfx.fillRect(cwidth/2+100,450,200,100);

	gfx.strokeStyle = gfx.fillStyle = 'black';
	gfx.fillRect(cwidth/2-280,470,160,60);
	gfx.fillRect(cwidth/2+120,470,160,60);

	gfx.strokeStyle = gfx.fillStyle = 'red';

	var pad = '';
	while((''+timer1+pad).length < 8){ pad += '0'; }
	gfx.fillText(timer1 + pad + ' T',cwidth/2-250,505);

	pad = '';
	while((''+timer2+pad).length < 8){ pad += '0'; }
	gfx.fillText(timer2 + pad + ' T',cwidth/2+150,505);
}

updateOrbit = function(){
	orbitEcc = eccbox.value;
	if(eccbox.value < 0){ eccbox.value = 0; orbitEcc = 0; }
	if(eccbox.value > 1){ eccbox.value = 1; orbitEcc = 1; }
	minbox.value = (''+aphelioVel()).substr(0,8) + ' km/s';
	maxbox.value = (''+perihelioVel()).substr(0,8) + ' km/s';
	if(semimajorbox.value.length > 0 && semimajorbox.value.indexOf('U') === -1){ semimajorbox.value += ' AU'; }
}

// equation from: http://people.bridgewater.edu/~rbowman/ISAW/KeplerCalc.html
aphelioVel = function(){
	var semi; var ecc;
	if(currentPlanet !== 'custom'){
		semi = planetData[currentPlanet].semimajor;
		ecc = planetData[currentPlanet].ecc;
	}else{
		semi = semimajorbox.value;
		ecc = eccbox.value;
	}
	var temp = (8.871*Math.pow(10,8)/semi);
	temp *= (1-ecc)/(1+ecc);
	temp = Math.sqrt(temp);
	temp /= 1000;
	return temp;
}

// equation from: http://people.bridgewater.edu/~rbowman/ISAW/KeplerCalc.html
perihelioVel = function(){
	var semi; var ecc;
	if(currentPlanet !== 'custom'){
		semi = planetData[currentPlanet].semimajor;
		ecc = planetData[currentPlanet].ecc;
	}else{
		semi = semimajorbox.value;
		ecc = eccbox.value;
	}
	var temp = (8.871*Math.pow(10,8)/semi);
	temp *= (1+ecc)/(1-ecc);
	temp = Math.sqrt(temp);
	temp /= 1000;
	return temp;
}

// formulas from: http://keisan.casio.com/exec/system/1343722709
ellipticalArchArea = function(theta0,theta1,a,e){
	var b = a*Math.sqrt(1-(e*e));

	var F = function(theta){
		return ((a*b)/2)*(theta-Math.atan(	((b-a)*Math.sin(2*theta)) /	(b+a+(b-a)*Math.cos(2*theta)) ));
	}
	
	var R = function(theta){
		return Math.sqrt((a*a*b*b)/(b*b*Math.cos(theta)*Math.cos(theta) + a*a*Math.sin(theta)*Math.sin(theta)));
	}

	return F(theta1)-F(theta0)-((R(theta0)*R(theta1))/2)*Math.sin(theta1-theta0);
}

lerp = function(oldMin,oldMax,oldVal,newMin,newMax){
	return (oldVal-oldMin)/(oldMax-oldMin)*(newMax-newMin)+newMin;
}

dist = function(x1,y1,x2,y2){ return Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2)); }

vec2 = function(x,y){ this.x = x; this.y = y; }
add = function(v1,v2){ return new vec2(v1.x+v2.x, v1.y+v2.y); }
sub = function(v1,v2){ return new vec2(v1.x-v2.x, v1.y-v2.y); }
dot = function(v1,v2){ return v1.x*v2.x + v1.y+v2.y; }
mag = function(v){ return dist(0,0,v.x,v.y); }
mult = function(v,s){ return new vec2(v.x*s,v.y*s); }
unit = function(v){ return new vec2(v.x/mag(v),v.y/mag(v)); }

ellipse2 = function(x1,y1,x2,y2,e,semimajor){
	var center = new vec2((x1+x2)/2,(y1+y2)/2);

	var up = new vec2(0,-1);
	var f = sub(new vec2(x1,y1), new vec2(x2,y2));
	var rot = Math.acos(dot(f,up)/(mag(f)*mag(up)));
	rot -= Math.PI/2;
	if(!rot){ rot = Math.PI/2; }

	gfx.save();
	gfx.translate(center.x,center.y);
	gfx.rotate(rot);
	gfx.beginPath();
	for(var i = 0; i < Math.PI*2; i += .01){
		var x = 1.0*semimajor*Math.cos(i);
		var y = (1-e)*semimajor*Math.sin(i)*(-1);
		if(i === 0){ gfx.moveTo(x,y); }else{ gfx.lineTo(x,y); } 
	}
	gfx.stroke();
	gfx.restore();
}
	</script>
</head>
<body bgcolor='grey'>
	<form style='position:absolute; left:62%; top:2%;'>
		<select id='planetSelect' style='width:200'>
				<option value = "0">Mercury</option>
				<option value = "1">Venus</option>
				<option value = "2">Earth</option>
				<option value = "3">Mars</option>
				<option value = "4">Jupiter</option>
				<option value = "5">Saturn</option>
				<option value = "6">Uranus</option>
				<option value = "7">Neptune</option>
				<option value = "8">Pluto</option>
				<option value = "9">Halley's Comet</option>
				<option value = "10">Custom</option>
		</select><br></br>
		<b1>Semimajor Axis: </b1><input type='textbox' id='semimajor' style='width:22%'><br></br>
		<b1>Eccentricity: </b1><input type='textbox' id='eccentricity' style='width:14%'><br></br>
		<input type='button' id='playpause' value='Play / Pause'><br></br>
		<input type='checkbox' id='slowmo'><b1>Slow Motion</b1><br></br>
		<input type='checkbox' id='showsectors' checked='true'><b1>Show Sectors</b1>
		&nbsp;&nbsp;&nbsp;&nbsp;
		<b1>Sector Size: </b1><input type='range' id='slider'><br></br>
		<input type='checkbox' id='showvel'><b1>Show Velocity Vector</b1><br></br>
		
		<b1>Distance from the Sun: </b1>
		<input type = 'textbox' id='distbox' style='width:28%' disabled>
		<br></br>
		
		<b1>Velocity</b1><br></br>
		
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<b1>Currently: </b1>
		<input type = 'textbox' id='curvel' style='width:30%' disabled>
		<br></br>
		
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<b1>Minimum: </b1>
		<input type = 'textbox' id='minvel' style='width:30%' disabled>
		<br></br>
		
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<b1>Maximum: </b1>
		<input type = 'textbox' id='maxvel' style='width:30%' disabled>
		<br></br>
	</form>
</body>